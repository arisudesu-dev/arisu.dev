# nginx

## Отбой на default_server https

С версии 1.19.4 умеет отклонять https на default_server. Это нужно, если предполагается, что сервер должен отвечать на виртуальные хосты, но не на собственное доменное имя или напрямую по ip.

Раньше нужно было ставить самоподписной сертификат, или не делать default_server для порта 443, тогда по ip или домену nginx отвечал первым попавшимся виртуальным хостом, с ошибкой проверки SSL.

С этой настройкой https запросы мимо виртуальных хостов будут отклоняться:

```
server {
    listen 443 ssl http2 default_server;
    ssl_reject_handshake on;
}
```

## Костыль для динамического proxy_pass в Docker

По умолчанию апстримы резолвятся только при запуске. Если перезапустить контейнер, на который проксирует nginx, то проксирование отвалится с 502 Bad Gateway. Можно зафорсировать резолв апстрима при входящих запросах, через переменную:

```
location / {
    resolver 127.0.0.11;
    set $upstream http://grafana:3000;
    proxy_pass $upstream;
}
```
